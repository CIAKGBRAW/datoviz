# Developer notes

## Manage script

A bash script `manage.sh` script at the repository root provides commands for build, test, doc generation, and so on.

## C formatting

We use clang format to automatically format all C source files. The rules are defined in `.clang-format`.

## Documentation

We use mkdocs, with material theme, and several markdown, theme, and mkdocs plugins. See `mkdocs.yml`. The site is generated in the `site/` subfolder. We use GitHub Pages to serve the website.

## Command-line tool

Datoviz includes an executable that implements test and examples, implemented in the `cli/` subfolder.

## Shaders and binary resource embedding

Important binary resources such as SPIR-V compiled shaders of all included graphics, and the colormap texture, are built directly into the compiled library object. A cmake script loads these files and generates big `build/_colortex.c` and `build/_shaders.c` files, which are then compiled and linked into the library.

## Documentation building

Several parts of the documentation are auto-generated, via mkdocs hooks implemented in `utils/hooks.py`. Building the documentation requires Python dependencies found in `utils/requirements-build.txt`. In particular, we use the `mkdocs-simple-hooks` package to make it possible to use custom Python functions as mkdocs plugin hooks.

* **API documentation**: the list of functions to document is found in the `docs/api/*.md` files. At documentation build time, the API doc generation script (`utils/gendoc.py`) parses the library header files, extracts the doxygen docstrings, and inserts them at the right places in the API documentation pages.
* **Enumerations**: the documentation file `api/enums.md` contains a list of headers of enumerations. A script parses the enums in the library header files and inserts them in this file, at documentation build time.
* **Colormaps**: colormaps definitions are saved in a CSV file in `data/textures/color_texture.csv`. This file is parsed by `utils/export_colormap.py` and the table of all colormaps is automatically generated, using NumPy and Pillow to generate base64-encoded individual colormap images. The table is inserted at the end of `docs/user/colormaps.md`.
* **Visual documentation**: visuals are documented manually. The screenshots are generated by the `builtin_visual.c` unit tests.
* **Graphics documentation**: the item, vertex, params structure fields are automatically generated by a script that parses the relevant struct definitions in the library header files.
* **Code snippets and screenshots**: the documentation build script parses `<!-- CODE_PYTHON path/to/file.py -->` and `<!-- IMAGE path/to/image.png -->` in documentation sources and inserts the code file contents, or the image.

!!! note
    The API doc generation uses joblib to save time when live-regenerating the documentation. However the cache in `utils/.joblib` must be deleted (so that it's automatically recreated) whenever the Datoviz code/API changes. Otherwise, the API doc generation script may fail.
